import streamlit as st
import pandas as pd
from mlxtend.preprocessing import TransactionEncoder
from mlxtend.frequent_patterns import fpgrowth, association_rules

# Load transaction data
file_path = "orders_details.xlsx"
df = pd.read_excel(file_path)
df['Items Bought'] = df['Items Bought'].apply(lambda x: x.split(','))

# Encode transactions
te = TransactionEncoder()
te_ary = te.fit(df['Items Bought']).transform(df['Items Bought'])
df_encoded = pd.DataFrame(te_ary, columns=te.columns_)

# FP-Growth for bundles
frequent_itemsets = fpgrowth(df_encoded, min_support=0.05, use_colnames=True)
frequent_itemsets['support_count'] = frequent_itemsets['support'] * len(df)
frequent_itemsets['length'] = frequent_itemsets['itemsets'].apply(lambda x: len(x))
bundle_itemsets = frequent_itemsets[frequent_itemsets['length'] >= 2]

# Association rules for recommendations
rules = association_rules(frequent_itemsets, metric="confidence", min_threshold=0.6)
rules = rules.sort_values(by='confidence', ascending=False)

st.set_page_config(page_title="Product Bundling & Recommendations", layout="wide")
st.title("📦 Product Bundling & 🤖 Recommendations Dashboard")

# --- Bundle Cards ---
st.subheader("Top Product Bundles")
for index, row in bundle_itemsets.iterrows():
    with st.container():
        st.markdown("""
            <div style='border: 1px solid #ddd; border-radius: 10px; padding: 15px; margin-bottom: 10px; background-color: #f9f9f9;'>
                <h4 style='margin-bottom: 10px;'>🧃 Bundle #{}</h4>
                <p><strong>Products:</strong> {}</p>
                <p><strong>Support Count:</strong> {}</p>
                <button style='padding: 5px 10px; background-color: #4CAF50; color: white; border: none; border-radius: 5px;'>💡 Mark as Suggested Combo</button>
            </div>
        """.format(index + 1, ', '.join(row['itemsets']), int(row['support_count'])), unsafe_allow_html=True)

# --- Recommendation Cards ---
st.subheader("Recommended Products")
for idx, row in rules.iterrows():
    with st.container():
        st.markdown("""
            <div style='border: 1px solid #ddd; border-radius: 10px; padding: 15px; margin-bottom: 10px; background-color: #eef6ff;'>
                <h4 style='margin-bottom: 10px;'>🔁 Recommendation #{}</h4>
                <p>🛒 <strong>If customer buys:</strong> {}</p>
                <p>👉 <strong>Recommend:</strong> {}</p>
                <p><strong>Confidence:</strong> {:.0f}%</p>
                <div style='margin-top: 10px;'>
                    <button style='padding: 5px 10px; background-color: #2196F3; color: white; border: none; border-radius: 5px; margin-right: 5px;'>🛍 Add to Cart</button>
                    <button style='padding: 5px 10px; background-color: #f0ad4e; color: white; border: none; border-radius: 5px;'>🔍 Show Similar Rules</button>
                </div>
            </div>
        """.format(idx + 1, ', '.join(row['antecedents']), ', '.join(row['consequents']), row['confidence'] * 100), unsafe_allow_html=True)
