import streamlit as st
import pandas as pd
from mlxtend.preprocessing import TransactionEncoder
from mlxtend.frequent_patterns import fpgrowth, association_rules

# Load transaction data
file_path = "orders_details.xlsx"
df = pd.read_excel(file_path)
df['Items Bought'] = df['Items Bought'].apply(lambda x: x.split(','))

# Encode transactions
te = TransactionEncoder()
te_ary = te.fit(df['Items Bought']).transform(df['Items Bought'])
df_encoded = pd.DataFrame(te_ary, columns=te.columns_)

# FP-Growth for bundles
frequent_itemsets = fpgrowth(df_encoded, min_support=0.05, use_colnames=True)
frequent_itemsets['support_count'] = frequent_itemsets['support'] * len(df)
frequent_itemsets['length'] = frequent_itemsets['itemsets'].apply(lambda x: len(x))
bundle_itemsets = frequent_itemsets[frequent_itemsets['length'] >= 2]

# Association rules for recommendations
rules = association_rules(frequent_itemsets, metric="confidence", min_threshold=0.6)
rules = rules.sort_values(by='confidence', ascending=False)

st.set_page_config(page_title="Product Bundling & Recommendations", layout="wide")
st.title("ğŸ“¦ Product Bundling & ğŸ¤– Recommendations Dashboard")

# --- Bundle Cards ---
st.subheader("Top Product Bundles")
for index, row in bundle_itemsets.iterrows():
    with st.container():
        cols = st.columns([3, 1])
        with cols[0]:
            st.markdown(f"**Products:** {', '.join(row['itemsets'])}")
            st.markdown(f"**Support Count:** {int(row['support_count'])}")
        with cols[1]:
            st.button("ğŸ’¡ Mark as Suggested Combo", key=f"bundle_{index}")

# --- Recommendation Cards ---
st.subheader("Recommended Products")
for idx, row in rules.iterrows():
    with st.container():
        cols = st.columns([3, 1])
        with cols[0]:
            st.markdown(f"ğŸ›’ If customer buys: **{', '.join(row['antecedents'])}**")
            st.markdown(f"ğŸ‘‰ Recommend: **{', '.join(row['consequents'])}**")
            st.markdown(f"Confidence: {row['confidence']:.2f} | Lift: {row['lift']:.2f}")
        with cols[1]:
            st.button("ğŸ› Add to Cart", key=f"rule_{idx}")
